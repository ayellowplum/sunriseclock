<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunrise Alarm</title>
    <style>
        /* --- Base & Typography --- */
        :root {
            --background: #000000;
            --foreground: #ffffff;
            --subtle: #9e9e9e;
            --accent: #ffffff;
            --overlay: #000000;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap');

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevents scrollbars */
        }

        body {
            background-color: var(--background);
            color: var(--foreground);
            font-family: 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: color 0.5s ease;
        }

        /* --- Main Layout & Clock --- */
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            padding: 2rem;
            z-index: 10;
        }

        #clock {
            font-size: clamp(4rem, 20vw, 10rem);
            font-weight: 300;
            letter-spacing: 2px;
            margin: 0;
        }

        #alarm-info {
            font-size: 1.2rem;
            color: var(--subtle);
            min-height: 1.5rem; /* Reserve space to prevent layout shift */
            transition: opacity 0.3s ease;
        }

        /* --- Controls --- */
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }

        #alarm-time-input {
            background-color: transparent;
            color: var(--foreground);
            border: 1px solid var(--subtle);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        .button {
            background-color: transparent;
            border: 1px solid var(--subtle);
            color: var(--subtle);
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        #set-alarm-btn .icon-bell {
            fill: none;
            stroke: var(--subtle);
            stroke-width: 1.5;
            transition: all 0.2s ease-in-out;
        }
        #set-alarm-btn:hover .icon-bell {
            stroke: var(--accent);
        }
        #set-alarm-btn.active .icon-bell {
            fill: var(--accent);
            stroke: var(--accent);
        }
        
        #stop-alarm-btn {
            display: none; /* Hidden by default */
            background-color: var(--foreground);
            color: var(--background);
            border-color: var(--foreground);
        }
        
        /* --- Customization Panel --- */
        details {
            width: 100%;
            max-width: 350px;
        }
        
        summary {
            color: var(--subtle);
            cursor: pointer;
            padding: 0.5rem;
            list-style: none; /* Remove default marker */
            transition: color 0.2s ease;
        }
        summary::-webkit-details-marker {
            display: none; /* Hide for Chrome */
        }
        
        summary:hover {
            color: var(--foreground);
        }
        
        .customization-panel {
            margin-top: 1rem;
            padding: 1.5rem;
            border: 1px solid #333;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            text-align: left;
        }

        .setting {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .setting label {
            color: var(--subtle);
            font-size: 0.9rem;
        }
        
        .setting .value-display {
            font-weight: 500;
            color: var(--foreground);
        }
        
        input[type="range"], select, input[type="text"], input[type="number"] {
            width: 100%;
            background-color: #1a1a1a;
            border: 1px solid #333;
            color: var(--foreground);
            padding: 0.5rem;
            border-radius: 4px;
            box-sizing: border-box; /* Important for consistent sizing */
        }
        
        input[type="range"] {
             -webkit-appearance: none;
             appearance: none;
             height: 8px;
             border-radius: 4px;
             background: #333;
             outline: none;
             padding: 0;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--foreground);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--foreground);
            cursor: pointer;
        }
        
        /* --- Sunrise & Player --- */
        #sunrise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--overlay);
            z-index: 5;
            pointer-events: none; /* Allows clicking through */
            opacity: 1;
            transition: opacity 1s linear; /* Default transition, JS will override */
        }

        #player-container {
            position: absolute;
            top: -9999px; /* Hide player off-screen */
            left: -9999px;
            width: 1px;
            height: 1px;
        }
    </style>
</head>
<body>

    <div id="sunrise-overlay"></div>

    <div class="container">
        <h1 id="clock">00:00:00</h1>
        <p id="alarm-info">No alarm set</p>

        <div class="controls">
            <input type="time" id="alarm-time-input">
            <button id="set-alarm-btn" class="button">
                <svg class="icon-bell" width="24" height="24" viewBox="0 0 24 24" stroke-linejoin="round" stroke-linecap="round">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
            </button>
            <button id="test-alarm-btn" class="button">Test Alarm</button>
            <button id="stop-alarm-btn" class="button">Stop Alarm</button>
        </div>

        <details>
            <summary>Customize</summary>
            <div class="customization-panel">
                <div class="setting">
                    <label for="sunrise-duration">Sunrise Duration: <span id="sunrise-duration-value" class="value-display">30 min</span></label>
                    <input type="range" id="sunrise-duration" min="1" max="60" value="30">
                </div>
                <div class="setting">
                    <label for="alarm-sound">Alarm Sound</label>
                    <select id="alarm-sound">
                        <option value="clair_de_lune">Clair de Lune</option>
                        <option value="gymnopedie_no_1">Gymnop√©die No. 1</option>
                        <option value="canon_in_d">Canon in D</option>
                        <option value="classic">Classic</option>
                        <option value="youtube">YouTube</option>
                        <option value="none">No Sound</option>
                    </select>
                </div>
                <div class="setting" id="youtube-setting">
                    <label for="youtube-url">YouTube Video/Stream URL</label>
                    <input type="text" id="youtube-url" placeholder="https://www.youtube.com/watch?v=...">
                </div>
                <div class="setting">
                    <label for="ring-duration">Ring Duration (min, 0 for forever)</label>
                    <input type="number" id="ring-duration" min="0" value="0">
                </div>
            </div>
        </details>
    </div>

    <!-- Hidden audio elements for built-in sounds -->
    <audio id="audio-clair_de_lune" loop src="sounds/clair_de_lune.mp3"></audio>
    <audio id="audio-gymnopedie_no_1" loop src="sounds/gymnopedie_no_1.mp3"></audio>
    <audio id="audio-canon_in_d" loop src="sounds/canon_in_d.mp3"></audio>
    <audio id="audio-classic" loop src="sounds/classic.mp3"></audio>

    <!-- Container for the YouTube player -->
    <div id="player-container"></div>

    <script>
        // --- DOM Elements ---
        const clockElement = document.getElementById('clock');
        const alarmInfoElement = document.getElementById('alarm-info');
        const alarmTimeInput = document.getElementById('alarm-time-input');
        const setAlarmBtn = document.getElementById('set-alarm-btn');
        const stopAlarmBtn = document.getElementById('stop-alarm-btn');
        const testAlarmBtn = document.getElementById('test-alarm-btn');
        const sunriseOverlay = document.getElementById('sunrise-overlay');
        const sunriseDurationInput = document.getElementById('sunrise-duration');
        const sunriseDurationValue = document.getElementById('sunrise-duration-value');
        const alarmSoundSelect = document.getElementById('alarm-sound');
        const youtubeSetting = document.getElementById('youtube-setting');
        const youtubeUrlInput = document.getElementById('youtube-url');
        const ringDurationInput = document.getElementById('ring-duration');

        // --- State Variables ---
        let alarmTime = null;
        let alarmInterval = null;
        let ringTimeout = null;
        let isAlarmActive = false;
        let isSunrisePeriod = false;
        let youtubePlayer;
        let isTestRunning = false;
        let testInterval = null;

        // --- Constants ---
        const TEST_ALARM_DURATION_MS = 15000; // 15 seconds for test

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setInterval(updateClock, 1000);
            updateClock();

            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            alarmTimeInput.value = `${hours}:${minutes}`;

            setAlarmBtn.addEventListener('click', toggleAlarm);
            stopAlarmBtn.addEventListener('click', stopAlarm);
            testAlarmBtn.addEventListener('click', runTestAlarm);
            alarmSoundSelect.addEventListener('change', handleSoundChange);
            sunriseDurationInput.addEventListener('input', handleSunriseDurationChange);
            
            handleSoundChange();
            handleSunriseDurationChange();
            loadYouTubeAPI();
        });

        // --- Clock Logic ---
        function updateClock() {
            const now = new Date();
            clockElement.textContent = now.toLocaleTimeString('en-US', { hour12: false });
        }

        // --- Alarm Logic ---
        function toggleAlarm() {
            if (isAlarmActive) {
                cancelAlarm();
            } else {
                setAlarm();
            }
        }

        function setAlarm() {
            const timeValue = alarmTimeInput.value;
            if (!timeValue) {
                updateAlarmInfo("Please select a time.");
                return;
            }

            const [hours, minutes] = timeValue.split(':');
            const now = new Date();
            const alarmDate = new Date();
            alarmDate.setHours(hours, minutes, 0, 0);

            if (alarmDate <= now) {
                alarmDate.setDate(alarmDate.getDate() + 1);
            }

            alarmTime = alarmDate;
            isAlarmActive = true;
            isSunrisePeriod = false;
            
            setAlarmBtn.classList.add('active');
            updateAlarmInfo(`Alarm set for ${alarmTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`);
            
            alarmTimeInput.disabled = true;
            
            if (alarmInterval) clearInterval(alarmInterval);
            alarmInterval = setInterval(checkAlarm, 1000);
        }

        function cancelAlarm() {
            clearInterval(alarmInterval);
            if(ringTimeout) clearTimeout(ringTimeout);
            alarmTime = null;
            isAlarmActive = false;
            isSunrisePeriod = false;
            setAlarmBtn.classList.remove('active');
            updateAlarmInfo("No alarm set");
            alarmTimeInput.disabled = false;
        }

        function checkAlarm() {
            if (!alarmTime || isTestRunning) return;

            const now = new Date();
            const sunriseDurationMinutes = parseInt(sunriseDurationInput.value, 10);
            const sunriseStartTime = new Date(alarmTime.getTime() - sunriseDurationMinutes * 60 * 1000);

            // Sunrise Period: From start of sunrise duration up to the alarm time
            if (now >= sunriseStartTime && now < alarmTime) {
                if (!isSunrisePeriod) {
                    isSunrisePeriod = true;
                    playAlarmSound(0); // Start sound silently
                }
                
                const totalDurationMs = alarmTime.getTime() - sunriseStartTime.getTime();
                const elapsedMs = now.getTime() - sunriseStartTime.getTime();
                
                // Visual and Volume progress are linear over the whole sunrise duration
                const progress = Math.min(elapsedMs / totalDurationMs, 1.0);
                sunriseOverlay.style.opacity = 1 - progress;
                setVolume(progress);

            }

            // Alarm Time: The exact moment the alarm is set for
            if (now >= alarmTime) {
                triggerAlarm();
            }
        }
        
        function triggerAlarm() {
            // Stop the check interval, the alarm is now ringing
            clearInterval(alarmInterval);

            sunriseOverlay.style.transition = 'opacity 0.5s linear';
            sunriseOverlay.style.opacity = '0';
            setVolume(1.0); // Ensure volume is at max
            
            if (!isSunrisePeriod) {
                 playAlarmSound(1.0); // Start sound if not already playing
            }
            
            stopAlarmBtn.style.display = 'flex';
            setAlarmBtn.style.display = 'none';
            testAlarmBtn.style.display = 'none';

            // Set timeout for how long the alarm rings, if specified
            const ringDurationMinutes = parseInt(ringDurationInput.value, 10);
            if (ringDurationMinutes > 0) {
                const ringDurationMs = ringDurationMinutes * 60 * 1000;
                ringTimeout = setTimeout(stopAlarm, ringDurationMs);
            }
        }

        function stopAlarm() {
            stopAlarmSound();
            
            // Clear the auto-stop timeout if it was set
            if(ringTimeout) clearTimeout(ringTimeout);
            
            // Reset UI
            stopAlarmBtn.style.display = 'none';
            setAlarmBtn.style.display = 'flex';
            testAlarmBtn.style.display = 'flex';
            alarmTimeInput.disabled = false;
            
            // Reset sunrise overlay
            sunriseOverlay.style.transition = 'opacity 0.5s linear';
            sunriseOverlay.style.opacity = '1';
            
            // Reset state variables
            isAlarmActive = false;
            isSunrisePeriod = false;
            alarmTime = null;

            if (isTestRunning) {
                isTestRunning = false;
                clearInterval(testInterval);
            }
            
            updateAlarmInfo("No alarm set");
        }
        
        function runTestAlarm() {
            if (isAlarmActive || isTestRunning) {
                updateAlarmInfo("Cannot test while an alarm is active.");
                return;
            }
            
            isTestRunning = true;
            updateAlarmInfo("Testing alarm...");

            playAlarmSound(0);

            stopAlarmBtn.style.display = 'flex';
            setAlarmBtn.style.display = 'none';
            testAlarmBtn.style.display = 'none';

            const testStartTime = Date.now();
            
            testInterval = setInterval(() => {
                const elapsedMs = Date.now() - testStartTime;
                
                // Fade in over the full test duration
                const progress = Math.min(elapsedMs / TEST_ALARM_DURATION_MS, 1.0);
                sunriseOverlay.style.opacity = 1 - progress;
                setVolume(progress);

                if (progress >= 1.0) {
                    clearInterval(testInterval);
                    // Let it ring for 2 seconds at full volume before stopping
                    setTimeout(() => {
                         if (isTestRunning) stopAlarm();
                    }, 2000);
                }
            }, 50);
        }


        // --- Sound Logic ---
        function playAlarmSound(startVolume = 1.0) {
            stopAlarmSound();
            const sound = alarmSoundSelect.value;
            
            setVolume(startVolume);

            if (sound === 'youtube') {
                const videoId = parseYouTubeUrl(youtubeUrlInput.value);
                if (videoId && youtubePlayer) {
                    youtubePlayer.loadVideoById(videoId);
                } else if (!videoId) {
                    updateAlarmInfo("Invalid YouTube URL. Playing no sound.");
                }
            } else if (sound !== 'none') {
                const audioElement = document.getElementById(`audio-${sound}`);
                if (audioElement) {
                    audioElement.play().catch(e => console.error("Audio play failed:", e));
                }
            }
        }

        function stopAlarmSound() {
            document.querySelectorAll('audio').forEach(audio => {
                audio.pause();
                audio.currentTime = 0;
                audio.volume = 1.0;
            });

            if (youtubePlayer && typeof youtubePlayer.stopVideo === 'function') {
                youtubePlayer.stopVideo();
                if (typeof youtubePlayer.setVolume === 'function') {
                    youtubePlayer.setVolume(100);
                }
            }
        }
        
        function setVolume(level) {
            const safeLevel = Math.max(0, Math.min(1, level));
            const sound = alarmSoundSelect.value;

            if (sound === 'youtube') {
                if (youtubePlayer && typeof youtubePlayer.setVolume === 'function') {
                    youtubePlayer.setVolume(safeLevel * 100);
                }
            } else if (sound !== 'none') {
                const audioElement = document.getElementById(`audio-${sound}`);
                if (audioElement) {
                    audioElement.volume = safeLevel;
                }
            }
        }

        // --- UI Handlers & Helpers ---
        function updateAlarmInfo(message) {
            alarmInfoElement.textContent = message;
        }

        function handleSoundChange() {
            youtubeSetting.style.display = alarmSoundSelect.value === 'youtube' ? 'flex' : 'none';
        }
        
        function handleSunriseDurationChange() {
             sunriseDurationValue.textContent = `${sunriseDurationInput.value} min`;
        }

        // --- YouTube IFrame API ---
        function loadYouTubeAPI() {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        function onYouTubeIframeAPIReady() {
            youtubePlayer = new YT.Player('player-container', {
                height: '1',
                width: '1',
                events: {
                    'onReady': (event) => {
                        if ((isSunrisePeriod || isTestRunning) && alarmSoundSelect.value === 'youtube') {
                            event.target.playVideo();
                        }
                    },
                    'onStateChange': (event) => {
                        if (event.data === YT.PlayerState.ENDED) {
                            youtubePlayer.playVideo();
                        }
                    }
                }
            });
        }
        
        function parseYouTubeUrl(url) {
            if (!url) return null;
            let videoId = null;
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname === 'youtu.be') {
                    videoId = urlObj.pathname.slice(1);
                } else if (urlObj.hostname.includes('youtube.com')) {
                    videoId = urlObj.searchParams.get('v');
                }
                if (videoId && /^[a-zA-Z0-9_-]{11}$/.test(videoId)) {
                    return videoId;
                }
            } catch (e) {
                console.error("Invalid URL for parsing:", e);
                return null;
            }
            return null;
        }
    </script>
</body>
</html>
